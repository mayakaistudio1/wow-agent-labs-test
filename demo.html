<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOW-Agent - AI Dialog Widget</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent: #00B8D4;
            --dark: #1A1A1A;
            --dark-lighter: #2D2D2D;
            --white: #FFFFFF;
            --gray: rgba(255, 255, 255, 0.7);
            --gray-light: rgba(255, 255, 255, 0.5);
            --border-radius: 12px;
            --chat-bg: rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--dark);
            color: var(--white);
            overflow: hidden;
            height: 100vh;
        }

        /* --- –≠–ö–†–ê–ù 1: –ü–†–ò–í–ï–¢–°–¢–í–ò–ï --- */
        #welcomeScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-lighter) 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 40px 20px; z-index: 1000;
        }
        #welcomeScreen.hidden { display: none; }
        #welcomeScreen h1 { font-size: 48px; font-weight: 900; margin-bottom: 10px; }
        #welcomeScreen h1 .accent { color: var(--accent); }
        
        #startBtn {
            background: var(--accent); color: var(--dark); padding: 18px 50px;
            border: none; border-radius: var(--border-radius); font-size: 18px; font-weight: 700;
            cursor: pointer; transition: all 0.3s ease; margin-top: 30px;
        }
        #startBtn:hover { background: #00A3C0; transform: translateY(-2px); }

        /* --- –≠–ö–†–ê–ù 2: –ó–ê–ì–†–£–ó–ö–ê --- */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1001;
        }
        #loadingScreen.hidden { display: none; }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 30px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- –≠–ö–†–ê–ù 3: –î–ò–ê–õ–û–ì --- */
        #chatScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column; z-index: 1002;
        }
        #chatScreen.hidden { display: none; }

        #videoContainer {
            flex: 1; position: relative; background: #000;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        #videoContainer video { width: 100%; height: 100%; object-fit: cover; }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .chat-header {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 20;
        }
        #statusBadge {
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 20px;
            font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #gray; }
        #statusBadge.listening .status-dot { background: #00FF00; animation: pulse 1.5s infinite; }
        #statusBadge.speaking .status-dot { background: #FF0000; animation: pulse 1.5s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        #closeBtn {
            background: rgba(0, 0, 0, 0.6); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px;
        }

        /* --- –ß–ê–¢ –û–ö–ù–û --- */
        #chatInterface {
            position: absolute; bottom: 20px; right: 20px; width: 350px;
            height: 400px; max-height: 50vh;
            background: var(--chat-bg); backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            display: flex; flex-direction: column;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 30;
            transition: transform 0.3s ease;
        }
        @media (max-width: 600px) {
            #chatInterface { width: calc(100% - 40px); height: 35vh; }
        }

        .chat-header-bar {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
        }
        #toggleChatBtn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        #chatMessages {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            font-size: 14px;
        }
        #chatMessages::-webkit-scrollbar { width: 6px; }
        #chatMessages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        .message {
            padding: 8px 12px; border-radius: 8px; max-width: 85%;
            word-wrap: break-word; line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.user {
            align-self: flex-end; background: var(--accent); color: var(--dark);
            border-bottom-right-radius: 2px;
        }
        .message.agent {
            align-self: flex-start; background: rgba(255,255,255,0.1); color: var(--white);
            border-bottom-left-radius: 2px;
        }
        .message.system {
            align-self: center;
            background: rgba(255,255,255,0.05);
            color: var(--gray-light);
            font-size: 12px;
            font-style: italic;
            max-width: 100%;
            text-align: center;
        }

        #chatInputContainer {
            padding: 10px; border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; gap: 8px;
        }
        #chatInput {
            flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 10px; border-radius: 8px; outline: none;
        }
        #chatInput:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #sendBtn {
            background: var(--accent); border: none; width: 40px; border-radius: 8px;
            cursor: pointer; font-size: 18px; color: var(--dark);
            transition: all 0.2s;
        }
        #sendBtn:hover:not(:disabled) {
            background: #00A3C0;
        }
        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        #instructionBanner {
            position: absolute; bottom: 440px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: var(--dark); padding: 8px 16px;
            border-radius: 20px; font-weight: 600; z-index: 10;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        #instructionBanner.visible { opacity: 1; }
        @media (max-width: 600px) { #instructionBanner { bottom: 38vh; } }

        /* --- –≠–ö–†–ê–ù 4: –ó–ê–í–ï–†–®–ï–ù–ò–ï --- */
        #thankYouScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); display: flex; align-items: center; justify-content: center;
            z-index: 1003; color: white;
        }
        #thankYouScreen.hidden { display: none; }
        .thank-you-card { text-align: center; max-width: 400px; padding: 20px; }
        .thank-you-card button {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 10px 20px; margin-top: 20px; border-radius: 8px; cursor: pointer;
        }

    </style>
</head>
<body>

    <div id="welcomeScreen">
        <h1>WOW<span class="accent">AGENT</span></h1>
        <p style="color:var(--gray)">–í–∏–¥–µ–æ-–¥–∏–∞–ª–æ–≥ —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º</p>
        <button id="startBtn">–ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä</button>
    </div>

    <div id="loadingScreen" class="hidden">
        <div class="spinner"></div>
        <p id="loadingText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>
    </div>

    <div id="chatScreen" class="hidden">
        <div id="videoContainer"></div>

        <div class="chat-header">
            <div id="statusBadge">
                <span class="status-dot"></span>
                <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
            <button id="closeBtn" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">‚úï</button>
        </div>

        <div id="instructionBanner">üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ –∏–ª–∏ –ø–∏—à–∏—Ç–µ...</div>

        <div id="chatInterface">
            <div class="chat-header-bar">
                <span class="chat-title">üí¨ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞</span>
                <button id="toggleChatBtn">‚îÄ</button>
            </div>
            <div id="chatMessages">
                <div class="message system">–î–∏–∞–ª–æ–≥ –Ω–∞—á–∞–ª—Å—è. –ì–æ–≤–æ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å–æ–º –∏–ª–∏ –ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º.</div>
            </div>
            <div id="chatInputContainer">
                <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <button id="sendBtn">‚û§</button>
            </div>
        </div>
    </div>

    <div id="thankYouScreen" class="hidden">
        <div class="thank-you-card">
            <h2>–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
            <button onclick="location.reload()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>
    </div>

    <script>
        // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===
        const state = {
            room: null,
            localMicTrack: null,
            sessionId: null,
            sessionToken: null,
            isAvatarSpeaking: false,
            isSendingMessage: false,
            messages: [] // –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        };

        const ui = {
            screens: {
                welcome: document.getElementById('welcomeScreen'),
                loading: document.getElementById('loadingScreen'),
                chat: document.getElementById('chatScreen'),
                thankYou: document.getElementById('thankYouScreen')
            },
            videoContainer: document.getElementById('videoContainer'),
            statusBadge: document.getElementById('statusBadge'),
            statusText: document.getElementById('statusText'),
            instructionBanner: document.getElementById('instructionBanner'),
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            sendBtn: document.getElementById('sendBtn'),
            startBtn: document.getElementById('startBtn'),
            closeBtn: document.getElementById('closeBtn'),
            toggleChatBtn: document.getElementById('toggleChatBtn')
        };

        // === –£—Ç–∏–ª–∏—Ç—ã ===
        function showScreen(name) {
            Object.values(ui.screens).forEach(el => el.classList.add('hidden'));
            ui.screens[name].classList.remove('hidden');
        }

        async function postJSON(url, body) {
            const r = await fetch(url, {
                method: "POST", headers: { "content-type": "application/json" },
                body: JSON.stringify(body || {})
            });
            if (!r.ok) throw new Error(await r.text());
            return r.json();
        }

        // === –ß–∞—Ç –õ–æ–≥–∏–∫–∞ ===
        function addChatMessage(text, sender = 'agent', silent = false) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.textContent = text;
            ui.chatMessages.appendChild(div);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (–∫—Ä–æ–º–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö)
            if (sender !== 'system' && !silent) {
                state.messages.push({
                    sender: sender,
                    text: text,
                    timestamp: new Date().toISOString()
                });
            }
        }

        async function sendUserMessage() {
            const text = ui.chatInput.value.trim();
            if (!text || state.isSendingMessage) return;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            addChatMessage(text, 'user');
            ui.chatInput.value = '';

            try {
                state.isSendingMessage = true;
                ui.sendBtn.disabled = true;
                ui.chatInput.disabled = true;

                // –í–ê–ñ–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API
                await postJSON("/api/send-event", {
                    session_token: state.sessionToken,
                    event_type: "chat",
                    data: { text: text }
                });

                console.log("‚úì –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≤–∞—Ç–∞—Ä—É:", text);

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
                addChatMessage("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è", 'system');
            } finally {
                state.isSendingMessage = false;
                ui.sendBtn.disabled = false;
                ui.chatInput.disabled = false;
                ui.chatInput.focus();
            }
        }

        // === LiveKit –õ–æ–≥–∏–∫–∞ ===
        async function connectLiveKit(payload) {
            if (state.room) await state.room.disconnect();

            const { Room, RoomEvent } = window.LivekitClient;
            state.room = new Room({ 
                adaptiveStream: true, 
                dynacast: true,
                autoSubscribe: true 
            });

            // 1. –ú–µ–¥–∏–∞ (–í–∏–¥–µ–æ/–ê—É–¥–∏–æ)
            state.room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
                console.log("Track subscribed:", track.kind, "from:", participant?.identity);
                
                const el = track.attach();
                if (track.kind === "video") {
                    ui.videoContainer.innerHTML = '';
                    ui.videoContainer.appendChild(el);
                } else if (track.kind === "audio") {
                    el.style.display = 'none';
                    document.body.appendChild(el);
                }
            });

            // 2. –î–∞–Ω–Ω—ã–µ (–°–æ–±—ã—Ç–∏—è + –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)
            state.room.on(RoomEvent.DataReceived, (payload, participant) => {
                try {
                    const str = new TextDecoder().decode(payload);
                    const event = JSON.parse(str);
                    
                    console.log("üì® Event received:", event);

                    // === –°–¢–ê–¢–£–°–´ –ê–í–ê–¢–ê–†–ê ===
                    if (event.type === 'avatar_start_talking' || event.type === 'avatar.started_talking') {
                        state.isAvatarSpeaking = true;
                        updateStatus('speaking');
                        // –û—Ç–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–∫–∞ –∞–≤–∞—Ç–∞—Ä –≥–æ–≤–æ—Ä–∏—Ç
                        if (state.localMicTrack) {
                            state.localMicTrack.mute();
                        }
                    }
                    
                    if (event.type === 'avatar_stop_talking' || event.type === 'avatar.stopped_talking') {
                        state.isAvatarSpeaking = false;
                        updateStatus('listening');
                        // –í–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –æ–±—Ä–∞—Ç–Ω–æ
                        if (state.localMicTrack) {
                            state.localMicTrack.unmute();
                        }
                    }

                    // === –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–≥–æ–ª–æ—Å ‚Üí —Ç–µ–∫—Å—Ç) ===
                    if (event.type === 'user_transcript' || event.type === 'user.transcript') {
                        if (event.text || event.transcript) {
                            const userText = event.text || event.transcript;
                            addChatMessage(userText, 'user');
                        }
                    }

                    // === –û–¢–í–ï–¢ –ê–í–ê–¢–ê–†–ê (—Ç–µ–∫—Å—Ç) ===
                    if (event.type === 'agent_response' || event.type === 'agent.response' || 
                        event.type === 'transcription' || event.type === 'avatar_message') {
                        if (event.text) {
                            addChatMessage(event.text, 'agent');
                        }
                    }

                    // === –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö (–µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥—Ä—É–≥–∞—è) ===
                    if (event.message && !event.type) {
                        addChatMessage(event.message, 'agent');
                    }

                } catch (e) { 
                    console.error("Error parsing event:", e); 
                }
            });

            state.room.on(RoomEvent.Disconnected, (reason) => {
                console.log("Disconnected:", reason);
                stopSession();
            });

            state.room.on(RoomEvent.ParticipantConnected, (participant) => {
                console.log("Participant connected:", participant.identity);
            });

            await state.room.connect(payload.livekit_url, payload.livekit_client_token);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—É–¥–∏–æ (–≤–∞–∂–Ω–æ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞)
            try {
                await state.room.startAudio();
                console.log("‚úì Audio started");
            } catch (e) {
                console.warn("Audio autoplay blocked:", e);
            }
        }

        function updateStatus(status) {
            ui.statusBadge.className = ''; 
            if (status === 'speaking') {
                ui.statusBadge.classList.add('speaking');
                ui.statusText.textContent = '–ê–≤–∞—Ç–∞—Ä –≥–æ–≤–æ—Ä–∏—Ç';
                ui.instructionBanner.classList.remove('visible');
                // –ë–ª–æ–∫–∏—Ä—É–µ–º —á–∞—Ç –ø–æ–∫–∞ –∞–≤–∞—Ç–∞—Ä –≥–æ–≤–æ—Ä–∏—Ç
                ui.chatInput.placeholder = '–î–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–≤–µ—Ç–∞...';
            } else {
                ui.statusBadge.classList.add('listening');
                ui.statusText.textContent = '–°–ª—É—à–∞–µ—Ç –≤–∞—Å';
                ui.instructionBanner.classList.add('visible');
                ui.chatInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...';
            }
        }

        // === –°—Ç–∞—Ä—Ç / –°—Ç–æ–ø ===
        async function startSession() {
            try {
                ui.startBtn.disabled = true;
                showScreen('loading');

                // 1. –¢–æ–∫–µ–Ω
                const tData = await postJSON("/api/token", { language: "ru" });
                state.sessionId = tData.session_id;
                state.sessionToken = tData.session_token;
                console.log("‚úì Token received:", state.sessionId);

                // 2. –°—Ç–∞—Ä—Ç —Å–µ—Å—Å–∏–∏
                const sData = await postJSON("/api/start", { session_token: state.sessionToken });
                console.log("‚úì Session started");
                
                // 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ LiveKit
                await connectLiveKit(sData.data || sData);

                // 4. –ú–∏–∫—Ä–æ—Ñ–æ–Ω (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ–º)
                try {
                    state.localMicTrack = await window.LivekitClient.createLocalAudioTrack({
                        echoCancellation: true, 
                        noiseSuppression: true,
                        autoGainControl: true
                    });
                    await state.room.localParticipant.publishTrack(state.localMicTrack);
                    console.log("‚úì Microphone enabled");
                } catch (e) { 
                    console.warn("Mic error:", e); 
                    addChatMessage("‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —á–∞—Ç.", 'system');
                }

                showScreen('chat');
                updateStatus('listening');
                ui.chatInput.focus();

            } catch (e) {
                console.error("Start error:", e);
                alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + e.message);
                showScreen('welcome');
                ui.startBtn.disabled = false;
            }
        }

        async function stopSession() {
            showScreen('thankYou');
            
            if (state.room) { 
                state.room.disconnect(); 
                state.room = null; 
            }
            
            if (state.sessionId) {
                await postJSON("/api/stop", { 
                    session_id: state.sessionId, 
                    session_token: state.sessionToken 
                }).catch((e) => console.error("Stop error:", e));
            }
            
            ui.startBtn.disabled = false;
        }

        // === Toggle Chat ===
        let chatMinimized = false;
        ui.toggleChatBtn.addEventListener('click', () => {
            chatMinimized = !chatMinimized;
            const chatInterface = document.getElementById('chatInterface');
            if (chatMinimized) {
                chatInterface.style.transform = 'translateY(350px)';
                ui.toggleChatBtn.textContent = '‚ñ≤';
            } else {
                chatInterface.style.transform = 'translateY(0)';
                ui.toggleChatBtn.textContent = '‚îÄ';
            }
        });

        // === –°–ª—É—à–∞—Ç–µ–ª–∏ ===
        ui.startBtn.addEventListener('click', startSession);
        ui.closeBtn.addEventListener('click', stopSession);
        
        // –ß–∞—Ç
        ui.sendBtn.addEventListener('click', sendUserMessage);
        ui.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !state.isSendingMessage) {
                sendUserMessage();
            }
        });

    </script>
</body>
</html>
