<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WOW Agent - Smart Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 42px;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 18px;
      opacity: 0.9;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .video-card {
      position: relative;
      padding: 0;
      overflow: hidden;
    }

    #videoContainer {
      width: 100%;
      aspect-ratio: 16/9;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #videoHint {
      color: rgba(255, 255, 255, 0.5);
      font-size: 16px;
      text-align: center;
      padding: 20px;
    }

    .status-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      z-index: 10;
    }

    .status-badge {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      color: white;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .status-badge.speaking {
      background: rgba(239, 68, 68, 0.9);
      animation: pulse 2s infinite;
    }

    .status-badge.listening {
      background: rgba(34, 197, 94, 0.9);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .timer-badge {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      color: white;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .controls {
      padding: 20px 24px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
    }

    .controls-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-secondary {
      background: white;
      color: #374151;
      border: 2px solid #e5e7eb;
    }

    .btn-mic {
      background: #10b981;
      color: white;
    }

    .btn-mic.active {
      background: #ef4444;
      animation: pulse 2s infinite;
    }

    .btn-mic:disabled {
      background: #9ca3af;
    }

    .input-field {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #667eea;
    }

    .role-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .role-btn {
      padding: 16px;
      text-align: left;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .role-btn:hover {
      border-color: #667eea;
      background: #f9fafb;
    }

    .role-btn.active {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .role-btn strong {
      display: block;
      font-size: 16px;
      margin-bottom: 4px;
      color: #111827;
    }

    .role-btn small {
      color: #6b7280;
      font-size: 13px;
    }

    .info-card {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
    }

    .info-card strong {
      display: block;
      color: #1e40af;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .info-card p {
      color: #1e3a8a;
      font-size: 14px;
      line-height: 1.5;
    }

    .debug-section {
      margin-top: 20px;
    }

    .debug-title {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .debug-box {
      background: #1f2937;
      color: #10b981;
      border-radius: 12px;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.6;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .status-text {
      padding: 12px;
      background: #f3f4f6;
      border-radius: 8px;
      font-size: 14px;
      color: #374151;
      margin: 12px 0;
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ WOW Agent Demo</h1>
      <p>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π AI-–∞–≤–∞—Ç–∞—Ä —Å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ–º –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è</p>
    </div>

    <div class="main-grid">
      <!-- –í–∏–¥–µ–æ —Å–µ–∫—Ü–∏—è -->
      <div class="card video-card">
        <div id="videoContainer">
          <div class="status-overlay">
            <div id="avatarStatus" class="status-badge">
              <div class="status-indicator"></div>
              <span>–û–∂–∏–¥–∞–Ω–∏–µ</span>
            </div>
            <div id="timer" class="timer-badge">--:--</div>
          </div>
          <div id="videoHint">
            –ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç —Å–µ—Å—Å–∏–∏" –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∞–≤–∞—Ç–∞—Ä—É
          </div>
        </div>

        <div class="controls">
          <div class="controls-row">
            <button id="startBtn" class="btn-primary">
              ‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç —Å–µ—Å—Å–∏–∏
            </button>
            <button id="stopBtn" class="btn-danger" disabled>
              ‚èπÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å
            </button>
            <button id="micBtn" class="btn-mic" disabled>
              üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω
            </button>
          </div>
          <div class="status-text" id="statusText">
            –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –∏ –Ω–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç —Å–µ—Å—Å–∏–∏"
          </div>
        </div>
      </div>

      <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
      <div>
        <div class="card">
          <h3 style="margin-bottom: 16px; color: #111827;">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π</h3>
          <div class="role-grid">
            <button class="role-btn active" data-role="sales">
              <strong>üìä –ü—Ä–æ–¥–∞–∂–∏</strong>
              <small>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –ª–∏–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è</small>
            </button>
            <button class="role-btn" data-role="partners">
              <strong>ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</strong>
              <small>–†–µ–∫—Ä—É—Ç–∏–Ω–≥ –∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥</small>
            </button>
            <button class="role-btn" data-role="investor">
              <strong>üíº –ò–Ω–≤–µ—Å—Ç–æ—Ä</strong>
              <small>–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞</small>
            </button>
            <button class="role-btn" data-role="support">
              <strong>üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</strong>
              <small>FAQ –∏ –ø–æ–º–æ—â—å –∫–ª–∏–µ–Ω—Ç–∞–º</small>
            </button>
          </div>

          <div style="margin-top: 16px;">
            <input 
              id="nameInput" 
              class="input-field" 
              placeholder="–í–∞—à–µ –∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
              style="width: 100%;"
            />
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="info-card">
            <strong>‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</strong>
            <p>
              –ê–≤–∞—Ç–∞—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. 
              –ú–∏–∫—Ä–æ—Ñ–æ–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –∞–≤–∞—Ç–∞—Ä –≥–æ–≤–æ—Ä–∏—Ç, 
              –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –∏ —É–ª—É—á—à–∞—è –∫–∞—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–∞.
            </p>
          </div>

          <div class="debug-section">
            <div class="debug-title">–°–æ–±—ã—Ç–∏—è LiveKit</div>
            <div id="debugBox" class="debug-box"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
  <script>
    // === –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===
    let state = {
      role: "sales",
      sessionId: null,
      sessionToken: null,
      room: null,
      localMicTrack: null,
      avatarSpeaking: false,
      countdown: null,
      secondsLeft: 0,
      videoEl: null,
      audioEl: null
    };

    // === DOM —ç–ª–µ–º–µ–Ω—Ç—ã ===
    const els = {
      startBtn: document.getElementById("startBtn"),
      stopBtn: document.getElementById("stopBtn"),
      micBtn: document.getElementById("micBtn"),
      statusText: document.getElementById("statusText"),
      timer: document.getElementById("timer"),
      avatarStatus: document.getElementById("avatarStatus"),
      debugBox: document.getElementById("debugBox"),
      videoContainer: document.getElementById("videoContainer"),
      videoHint: document.getElementById("videoHint"),
      nameInput: document.getElementById("nameInput")
    };

    // === –£—Ç–∏–ª–∏—Ç—ã ===
    function log(msg) {
      const timestamp = new Date().toLocaleTimeString('ru-RU');
      const line = typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2);
      els.debugBox.textContent += `[${timestamp}] ${line}\n`;
      els.debugBox.scrollTop = els.debugBox.scrollHeight;
    }

    function updateAvatarStatus(status, speaking = false) {
      const badge = els.avatarStatus;
      const indicator = badge.querySelector('.status-indicator');
      const text = badge.querySelector('span');
      
      badge.className = 'status-badge';
      if (speaking) {
        badge.classList.add('speaking');
        text.textContent = 'üî¥ –ê–≤–∞—Ç–∞—Ä –≥–æ–≤–æ—Ä–∏—Ç';
      } else if (status === 'listening') {
        badge.classList.add('listening');
        text.textContent = 'üü¢ –ê–≤–∞—Ç–∞—Ä —Å–ª—É—à–∞–µ—Ç';
      } else {
        text.textContent = status;
      }
    }

    async function postJSON(url, body) {
      const r = await fetch(url, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const text = await r.text();
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch {}
      if (!r.ok) throw new Error(json?.error || json?.message || text);
      return json;
    }

    // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞ ===
    function cleanupMedia() {
      if (state.videoEl) {
        state.videoEl.srcObject = null;
        state.videoEl.remove();
        state.videoEl = null;
      }
      if (state.audioEl) {
        state.audioEl.srcObject = null;
        state.audioEl.remove();
        state.audioEl = null;
      }
      if (els.videoHint) {
        els.videoHint.style.display = 'flex';
      }
    }

    // === –¢–∞–π–º–µ—Ä ===
    function startTimer() {
      clearInterval(state.countdown);
      state.secondsLeft = 60;
      updateTimerDisplay();
      
      state.countdown = setInterval(async () => {
        state.secondsLeft -= 1;
        updateTimerDisplay();
        
        if (state.secondsLeft <= 0) {
          clearInterval(state.countdown);
          await stopSession();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const mins = Math.floor(state.secondsLeft / 60);
      const secs = state.secondsLeft % 60;
      els.timer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // === LiveKit –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ===
    async function connectLiveKit(payload) {
      if (!window.LivekitClient) {
        throw new Error("LiveKit SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
      }

      const lkUrl = payload?.livekit_url;
      const lkToken = payload?.livekit_client_token;

      if (!lkUrl || !lkToken) {
        throw new Error("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ LiveKit");
      }

      if (state.room) {
        try { state.room.disconnect(); } catch {}
        state.room = null;
      }
      cleanupMedia();

      const { Room, RoomEvent } = window.LivekitClient;

      state.room = new Room({
        adaptiveStream: true,
        dynacast: true,
        autoSubscribe: true,
      });

      log("üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ LiveKit...");

      // === –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ===
      state.room.on(RoomEvent.ParticipantConnected, (p) => {
        log(`‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω: ${p.identity}`);
      });

      // === –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–µ–∫–æ–≤ ===
      state.room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
        const who = participant?.identity || "remote";
        log(`üé¨ –¢—Ä–µ–∫ –ø–æ–ª—É—á–µ–Ω: ${track.kind} –æ—Ç ${who}`);

        if (who === "heygen") {
          if (track.kind === "video") {
            if (els.videoHint) els.videoHint.style.display = 'none';
            
            if (state.videoEl) {
              state.videoEl.srcObject = null;
              state.videoEl.remove();
            }

            const el = track.attach();
            el.autoplay = true;
            el.playsInline = true;
            el.style.width = "100%";
            el.style.height = "100%";
            el.style.objectFit = "cover";
            els.videoContainer.appendChild(el);
            state.videoEl = el;
            
            log("‚úÖ –í–∏–¥–µ–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ");
          }

          if (track.kind === "audio") {
            if (state.audioEl) {
              try { state.audioEl.pause?.(); } catch {}
              state.audioEl.srcObject = null;
              state.audioEl.remove();
            }

            const el = track.attach();
            el.autoplay = true;
            el.muted = false;
            el.volume = 1;
            document.body.appendChild(el);
            state.audioEl = el;

            el.play()
              .then(() => log("‚úÖ –ê—É–¥–∏–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è"))
              .catch(err => log(`‚ùå –û—à–∏–±–∫–∞ –∞—É–¥–∏–æ: ${err.message}`));
          }
        }
      });

      // === –í–ê–ñ–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ Data Messages –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ ===
      state.room.on(RoomEvent.DataReceived, (payload, participant) => {
        try {
          const data = new TextDecoder().decode(payload);
          const event = JSON.parse(data);
          
          log(`üì® –°–æ–±—ã—Ç–∏–µ: ${event.type || 'unknown'}`);

  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞
if (event.type === 'avatar.started_talking') {
  state.avatarSpeaking = true;
  updateAvatarStatus('–ì–æ–≤–æ—Ä–∏—Ç', true);
  
  // ‚úÖ –§–ò–ó–ò–ß–ï–°–ö–ò –û–¢–ö–õ–Æ–ß–ê–ï–ú –ú–ò–ö–†–û–§–û–ù
  if (state.localMicTrack && !state.localMicTrack.isMuted) {
    log("üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω MUTE (–∞–≤–∞—Ç–∞—Ä –≥–æ–≤–æ—Ä–∏—Ç)");
    try {
      state.localMicTrack.mute();
    } catch (e) {
      log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ mute: ${e.message}`);
    }
  }
}

if (event.type === 'avatar.stopped_talking') {
  state.avatarSpeaking = false;
  updateAvatarStatus('–°–ª—É—à–∞–µ—Ç', false);
  
  // ‚úÖ –§–ò–ó–ò–ß–ï–°–ö–ò –í–ö–õ–Æ–ß–ê–ï–ú –ú–ò–ö–†–û–§–û–ù
  if (state.localMicTrack && state.localMicTrack.isMuted) {
    log("üîä –ú–∏–∫—Ä–æ—Ñ–æ–Ω UNMUTE (–∞–≤–∞—Ç–∞—Ä –∑–∞–∫–æ–Ω—á–∏–ª)");
    try {
      state.localMicTrack.unmute();
    } catch (e) {
      log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ unmute: ${e.message}`);
    }
  }
}


          if (event.type === 'conversation.turn_completed') {
            log("‚úÖ –†–µ–ø–ª–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
          }
        } catch (e) {
          log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è: ${e.message}`);
        }
      });

      state.room.on(RoomEvent.Disconnected, (reason) => {
        log(`üîå –û—Ç–∫–ª—é—á–µ–Ω–æ: ${reason || 'unknown'}`);
        cleanupMedia();
        state.room = null;
      });

      await state.room.connect(lkUrl, lkToken);

      if (typeof state.room.startAudio === "function") {
        try {
          await state.room.startAudio();
          log("üîä –ê—É–¥–∏–æ –∑–∞–ø—É—â–µ–Ω–æ");
        } catch (e) {
          log(`‚ö†Ô∏è –ê—É–¥–∏–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${e.message}`);
        }
      }

      els.micBtn.disabled = false;
      updateAvatarStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω');
      log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ: ${state.room.name}`);
    }

    // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–µ–π ===
    async function startSession() {
      els.statusText.textContent = "‚è≥ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Å–µ—Å—Å–∏–∏...";
      els.debugBox.textContent = "";

      try {
        log("üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Å—Å–∏–∏...");
        
        const tokenData = await postJSON("/api/token", { language: "ru" });
        state.sessionId = tokenData.session_id;
        state.sessionToken = tokenData.session_token;
        
        log(`‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: ${state.sessionId}`);
        els.statusText.textContent = "‚è≥ –ó–∞–ø—É—Å–∫ —Å–µ—Å—Å–∏–∏...";

        const startData = await postJSON("/api/start", { 
          session_token: state.sessionToken 
        });
        
        const payload = startData?.data ?? startData;
        log("‚úÖ –°–µ—Å—Å–∏—è –∑–∞–ø—É—â–µ–Ω–∞");

        await connectLiveKit(payload);

        els.startBtn.disabled = true;
        els.stopBtn.disabled = false;
        els.statusText.textContent = `‚úÖ –°–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞ (—Ä–æ–ª—å: ${state.role})`;
        
        startTimer();
      } catch (e) {
        els.statusText.textContent = `‚ùå –û—à–∏–±–∫–∞: ${e.message}`;
        log(`‚ùå –û–®–ò–ë–ö–ê: ${e.message}`);
        console.error(e);
      }
    }

    async function stopSession() {
      els.statusText.textContent = "‚è≥ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏...";
      
      try {
        log("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Å—Å–∏–∏...");
        
        await postJSON("/api/stop", { 
          session_id: state.sessionId, 
          session_token: state.sessionToken 
        });

        if (state.room) {
          try { state.room.disconnect(); } catch {}
          state.room = null;
        }
        
        cleanupMedia();
        clearInterval(state.countdown);

        els.startBtn.disabled = false;
        els.stopBtn.disabled = true;
        els.micBtn.disabled = true;
        els.micBtn.classList.remove('active');
        
        updateAvatarStatus('–ó–∞–≤–µ—Ä—à–µ–Ω–æ');
        els.statusText.textContent = "‚úÖ –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é.";
        log("‚úÖ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
      } catch (e) {
        els.statusText.textContent = `‚ùå –û—à–∏–±–∫–∞: ${e.message}`;
        log(`‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ${e.message}`);
      }
    }

    // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º ===
    async function toggleMicrophone() {
      try {
        if (!state.room) {
          throw new Error("–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Å—Å–∏—é");
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç –ª–∏ –∞–≤–∞—Ç–∞—Ä
        if (state.avatarSpeaking) {
          log("‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: –∞–≤–∞—Ç–∞—Ä –≥–æ–≤–æ—Ä–∏—Ç");
          els.statusText.textContent = "‚ö†Ô∏è –î–æ–∂–¥–∏—Ç–µ—Å—å, –ø–æ–∫–∞ –∞–≤–∞—Ç–∞—Ä –∑–∞–∫–æ–Ω—á–∏—Ç –≥–æ–≤–æ—Ä–∏—Ç—å";
          return;
        }

        if (state.localMicTrack) {
          // –í—ã–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
          try { 
            await state.room.localParticipant.unpublishTrack(state.localMicTrack); 
          } catch {}
          try { 
            state.localMicTrack.stop(); 
          } catch {}
          state.localMicTrack = null;

          els.micBtn.classList.remove('active');
          els.micBtn.textContent = "üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω";
          log("üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω");
        } else {
          // –í–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
          log("üé§ –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...");
          
          state.localMicTrack = await window.LivekitClient.createLocalAudioTrack({
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
          });

          await state.room.localParticipant.publishTrack(state.localMicTrack);

          els.micBtn.classList.add('active');
          els.micBtn.textContent = "üî¥ –ú–∏–∫—Ä–æ—Ñ–æ–Ω (–≤–∫–ª)";
          log("‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω");
        }
      } catch (e) {
        log(`‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ${e.message}`);
        els.statusText.textContent = `‚ùå –û—à–∏–±–∫–∞: ${e.message}`;
      }
    }

    // === –í—ã–±–æ—Ä —Ä–æ–ª–∏ ===
    document.querySelectorAll('.role-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.role = btn.dataset.role;
        log(`üìã –í—ã–±—Ä–∞–Ω–∞ —Ä–æ–ª—å: ${state.role}`);
      });
    });

    // === –°–æ–±—ã—Ç–∏—è –∫–Ω–æ–ø–æ–∫ ===
    els.startBtn.addEventListener('click', startSession);
    els.stopBtn.addEventListener('click', stopSession);
    els.micBtn.addEventListener('click', toggleMicrophone);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    log("‚ú® WOW Agent Demo –∑–∞–≥—Ä—É–∂–µ–Ω");
    log("üí° –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –∏ –Ω–∞–∂–º–∏—Ç–µ '–°—Ç–∞—Ä—Ç —Å–µ—Å—Å–∏–∏'");
  </script>
</body>
</html>
